import os
from cryptography.fernet import Fernet

# Загрузка ключа шифрования из файла
with open('encryption_key.key', 'rb') as key_file:
    key = key_file.read()
cipher_suite = Fernet(key)  

def decrypt_file(file_path):
    # Чтение зашифрованных данных из файла
    with open(file_path, 'rb') as encrypted_file:
        encrypted_data = encrypted_file.read()
    
    # Расшифровка данных
    decrypted_data = cipher_suite.decrypt(encrypted_data)
    
    # Запись расшифрованных данных обратно в файл
    with open(file_path.replace('.encrypted', ''), 'wb') as decrypted_file:
        decrypted_file.write(decrypted_data)

        # Удаление зашифрованного файла
        os.remove(file_path)

def decrypt_directory(directory_path):
    print(f"Search files in directory: {directory_path}")
    # Перебор всех зашифрованных файлов в директории и поддиректориях
    for root, dirs, files in os.walk(directory_path):
        for file in files:
            if file.endswith('.encrypted'):  # Проверка на расширение файла
                file_path = os.path.join(root, file)
                decrypt_file(file_path)
                
# Путь к директории с зашифрованными файлами
directory_to_decrypt = './testfolder/'

decrypt_directory(directory_to_decrypt)

print("File decryption is ended")
